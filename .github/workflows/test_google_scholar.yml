name: Test Google Scholar Only

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'Test Google Scholar harvest script'
        required: false
        default: 'Testing Google Scholar with benchmark-2 query'

jobs:
  test-google-scholar:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyyaml requests
      
      - name: Create test ELIS config
        run: |
          cat > config/elis_search_queries.yml << 'EOF'
          global:
            year_from: 2002
            year_to: 2023
            languages:
              - en
            max_results_per_source: 100
            job_result_cap: 0
          topics:
            - id: benchmark_test_gs
              enabled: true
              description: 'Test Google Scholar with benchmark-2 query'
              queries:
                - '("agile" AND "government") OR ("agile" AND "governance") OR ("agile" AND "public")'
              include_preprints: false
              sources:
                - google_scholar
          EOF
          echo "✓ Test config created"
      
      - name: Run Google Scholar Harvest
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          PYTHONIOENCODING: utf-8
        run: |
          echo "Starting Google Scholar test..."
          python scripts/google_scholar_harvest.py
      
      - name: Check Results
        run: |
          if [ -f json_jsonl/ELIS_Appendix_A_Search_rows.json ]; then
            echo "✓ Output file exists"
            RESULTS=$(cat json_jsonl/ELIS_Appendix_A_Search_rows.json | python -c "import sys, json; print(len(json.load(sys.stdin)))")
            echo "✓ Retrieved: $RESULTS results"
            
            if [ "$RESULTS" -gt 0 ]; then
              echo "✅ GOOGLE SCHOLAR TEST PASSED"
              cat json_jsonl/ELIS_Appendix_A_Search_rows.json | python -c "import sys, json; r=json.load(sys.stdin)[0]; print(f\"Sample: {r.get('title', 'N/A')[:80]}...\")"
              exit 0
            else
              echo "⚠️ GOOGLE SCHOLAR RETURNED 0 RESULTS"
              exit 1
            fi
          else
            echo "❌ No output file generated"
            exit 1
          fi
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: google-scholar-test-results
          path: json_jsonl/ELIS_Appendix_A_Search_rows.json