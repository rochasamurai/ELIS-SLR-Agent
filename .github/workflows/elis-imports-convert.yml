name: ELIS - Imports Convert
# =============================================================================
# Purpose
#   Convert manual exports from external databases (currently Scopus CSV) into
#   the canonical Appendix A JSON artefact:
#       json_jsonl/ELIS_Appendix_A_Search_rows.json
#
#   The workflow can:
#     - run in PREVIEW mode (convert + upload artefact only), or
#     - write changes to a dedicated work branch and open/refresh a PR so the
#       new Appendix A becomes part of the main history.
#
# Notes
#   - The CSV export file must already live in the repository, usually under
#     the imports/ folder.
#   - Conversion logic lives in scripts/elis/imports_to_appendix_a.py.
#   - All work happens on GitHub; local runs are reserved for emergencies.
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      export_provider:
        description: "Export provider/format (currently: scopus_csv)"
        type: string
        default: "scopus_csv"
        required: true
      csv_path:
        description: "Path to the export file under the repo (e.g., imports/scopus_export.csv)"
        type: string
        default: "imports/scopus_export.csv"
        required: true
      topic_id:
        description: "Topic id for provenance (e.g., scopus_ui_manual)"
        type: string
        default: "scopus_ui_manual"
        required: true
      search_string:
        description: "Exact search string used in the provider UI (optional)"
        type: string
        default: ""
        required: false
      year_from:
        description: "Lower bound year used in the search (metadata only)"
        type: string
        default: "1990"
        required: true
      year_to:
        description: "Upper bound year used in the search (metadata only)"
        type: string
        default: "2025"
        required: true
      languages:
        description: "Comma-separated list of languages (metadata only)"
        type: string
        default: "en,fr,es,pt"
        required: true
      base_branch:
        description: "Base branch to PR into"
        type: string
        default: "main"
        required: true
      write_branch:
        description: "Work branch to write Appendix A artefact (auto-created/updated)"
        type: string
        default: "ci/imports-appendix-a-autopr"
        required: true
      preview_only:
        description: "Preview only (no commit/PR; artefact + summary only)"
        type: boolean
        default: false
        required: true

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: imports-convert-${{ github.ref }}
  cancel-in-progress: false

jobs:
  convert:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    env:
      APPENDIX_A_PATH: json_jsonl/ELIS_Appendix_A_Search_rows.json
      CHANNEL: manual_import

    steps:
      # -----------------------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.base_branch }}

      # -----------------------------------------------------------------------
      # Set up Python (reuse project runtime deps)
      # -----------------------------------------------------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install runtime dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------------------------------------------------
      # Convert CSV export → Appendix A JSON
      # -----------------------------------------------------------------------
      - name: Convert export to Appendix A JSON
        id: convert
        env:
          PROVIDER:      ${{ inputs.export_provider }}
          CSV_PATH:      ${{ inputs.csv_path }}
          TOPIC_ID:      ${{ inputs.topic_id }}
          SEARCH_STRING: ${{ inputs.search_string }}
          YEAR_FROM:     ${{ inputs.year_from }}
          YEAR_TO:       ${{ inputs.year_to }}
          LANGUAGES:     ${{ inputs.languages }}
          OUT_PATH:      ${{ env.APPENDIX_A_PATH }}
        run: |
          set -euo pipefail

          if [ ! -f "${CSV_PATH}" ]; then
            echo "::error::CSV export not found at ${CSV_PATH} (path is relative to repo root)."
            exit 1
          fi

          echo "Running imports_to_appendix_a.py for provider=${PROVIDER} CSV=${CSV_PATH}"

          python scripts/elis/imports_to_appendix_a.py \
            --provider "${PROVIDER}" \
            --csv "${CSV_PATH}" \
            --query-topic "${TOPIC_ID}" \
            --query-string "${SEARCH_STRING}" \
            --year-from "${YEAR_FROM}" \
            --year-to "${YEAR_TO}" \
            --languages "${LANGUAGES}"

          if [ ! -f "${OUT_PATH}" ]; then
            echo "::error::Expected output JSON not found at ${OUT_PATH}."
            exit 1
          fi

      # -----------------------------------------------------------------------
      # Summarise the resulting Appendix A file
      # -----------------------------------------------------------------------
      - name: Imports → Appendix A summary
        id: summary
        env:
          APPENDIX_A_PATH: ${{ env.APPENDIX_A_PATH }}
          CHANNEL:         ${{ env.CHANNEL }}
          PROVIDER:        ${{ inputs.export_provider }}
          TOPIC_ID:        ${{ inputs.topic_id }}
        run: |
          set -euo pipefail
          file="${APPENDIX_A_PATH}"

          if [ ! -f "${file}" ]; then
            echo "::error::Appendix A JSON not found at ${file}"
            exit 1
          fi

          total=$(jq '.[1:] | length' "${file}")
          echo "total=${total}" >> "$GITHUB_OUTPUT"

          {
            echo "## Imports → Appendix A summary"
            echo ""
            echo "- Channel: \`${CHANNEL}\`"
            echo "- Provider: \`${PROVIDER}\`"
            echo "- Output file: \`${file}\`"
            echo "- Total unique records: **${total}**"
            echo ""
            echo "### Topics"
            echo ""
            echo "- \`${TOPIC_ID}\`"
            echo ""
            echo "### Per source"
            echo ""
            echo "| Source | Records |"
            echo "|--------|---------|"
            jq -r '.[1:] | group_by(.source) | map({k: .[0].source, c: length}) | .[] | "| \(.k) | \(.c) |"' "${file}"
            echo ""
            echo "### Per topic"
            echo ""
            echo "| Topic ID | Records |"
            echo "|----------|---------|"
            jq -r '.[1:] | group_by(.query_topic) | map({k: .[0].query_topic, c: length}) | .[] | "| \(.k) | \(.c) |"' "${file}"
          } >> "$GITHUB_STEP_SUMMARY"

      # -----------------------------------------------------------------------
      # Upload the JSON as a build artefact (always)
      # -----------------------------------------------------------------------
      - name: Upload Appendix A JSON artefact
        uses: actions/upload-artifact@v4
        with:
          name: elis-imports-appendix-a
          path: ${{ env.APPENDIX_A_PATH }}

      # -----------------------------------------------------------------------
      # Create/update PR with the updated Appendix A file (non-preview only)
      # -----------------------------------------------------------------------
      - name: Create or update PR with converted Appendix A
        if: ${{ inputs.preview_only == false }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: ${{ inputs.base_branch }}
          branch: ${{ inputs.write_branch }}
          commit-message: "feat(imports): update Appendix A from manual import"
          title: "feat(imports): update Appendix A results from manual import"
          body: >
            This PR updates `json_jsonl/ELIS_Appendix_A_Search_rows.json` using a manual CSV export converted by the **ELIS - Imports Convert** workflow. The Step Summary in the workflow run shows per-source and per-topic record counts for quick review.
          add-paths: |
            json_jsonl/ELIS_Appendix_A_Search_rows.json
          author: "elis-bot <elis-bot@users.noreply.github.com>"
          labels: |
            area:appendix-a
            kind:imports
