name: Benchmark Validation - Darmawan 2021

on:
  workflow_dispatch:
    inputs:
      run_description:
        description: 'Description of this benchmark run'
        required: false
        default: 'Manual benchmark validation'

jobs:
  benchmark:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout benchmark branch
        uses: actions/checkout@v4
        with:
          ref: benchmark/darmawan-2021
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pandas pyyaml
      
      - name: Run ELIS search with benchmark config
        env:
          SCOPUS_API_KEY: ${{ secrets.SCOPUS_API_KEY }}
          WOS_API_KEY: ${{ secrets.WOS_API_KEY }}
          SEMANTIC_SCHOLAR_API_KEY: ${{ secrets.SEMANTIC_SCHOLAR_API_KEY }}
        run: |
          python scripts/elis/search_mvp.py \
            --config config/benchmark_temp_queries.yml \
            --output json_jsonl/benchmark_search_results.json
      
      - name: Run benchmark validation
        run: |
          python scripts/run_benchmark.py
      
      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-validation-report
          path: |
            docs/BENCHMARK_VALIDATION_REPORT.md
            data/benchmark/*.json
      
      - name: Comment results on commit
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('docs/BENCHMARK_VALIDATION_REPORT.md', 'utf8');
            
            // Extract key metrics
            const retrievalMatch = report.match(/Retrieval Rate.*?(\d+\.?\d*)%/);
            const retrieval = retrievalMatch ? retrievalMatch[1] : 'N/A';
            
            const status = parseFloat(retrieval) >= 70 ? '✅ PASS' : '❌ FAIL';
            
            const summary = `
            ## Benchmark Validation Results ${status}
            
            **Retrieval Rate:** ${retrieval}%
            **Target:** ≥70%
            
            <details>
            <summary>Full Report</summary>
            
            ${report}
            
            </details>
            `;
            
            // Post as comment
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: summary
            });
            