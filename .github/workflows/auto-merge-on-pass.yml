name: Auto-merge on Validator PASS

on:
  push:
    branches:
      - 'feature/**'
      - 'chore/**'
      - 'hotfix/**'

jobs:
  gate-2:
    name: Parse verdict and auto-merge if PASS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Parse verdict from REVIEW file
        id: verdict
        run: python scripts/parse_verdict.py
        # Outputs: verdict=PASS|FAIL|IN_PROGRESS, review_file=REVIEW_PEN.md

      - name: Check for PM veto label
        id: labels
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.ref_name}`,
              state: 'open'
            });
            if (pr.length === 0) { core.setOutput('veto', 'no-pr'); return; }
            const labels = pr[0].labels.map(l => l.name);
            core.setOutput('veto', labels.includes('pm-review-required') ? 'true' : 'false');
            core.setOutput('pr_number', pr[0].number);

      - name: Auto-merge if PASS and no veto
        if: |
          steps.verdict.outputs.verdict == 'PASS' &&
          steps.labels.outputs.veto == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.labels.outputs.pr_number }}');
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash',
              commit_title: `Merge PE: auto-merged on Validator PASS`
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '## ‚úÖ Gate 2 ‚Äî auto-merged\n\nValidator PASS verdict confirmed. PR merged automatically.\nPM audit trail: REVIEW file committed on branch.'
            });

      - name: Notify PM ‚Äî veto label present
        if: |
          steps.verdict.outputs.verdict == 'PASS' &&
          steps.labels.outputs.veto == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.labels.outputs.pr_number }}');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '## üîí Gate 2 ‚Äî PM approval required\n\nValidator PASS confirmed but `pm-review-required` label is set.\nPM must manually approve and merge.'
            });

      - name: Notify PM ‚Äî FAIL verdict
        if: steps.verdict.outputs.verdict == 'FAIL'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.labels.outputs.pr_number }}');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '## ‚ùå Gate 2 ‚Äî FAIL verdict\n\nValidator issued FAIL. Assigning Implementer to fix blocking findings.\n\n@codex ‚Äî read REVIEW file on this branch. Fix blocking findings only. Deliver updated Status Packet.'
            });
