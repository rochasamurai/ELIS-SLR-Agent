# ELIS - CI
# Purpose:
#   Run quality gates (Ruff, Black check, Pytest) and the ELIS validator
#   on Pull Requests and on pushes to main. Job names are stable to match
#   branch protection rules: 'quality' and 'validate'.

name: ELIS - CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  quality:
    name: quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tooling (ruff/black/pytest)
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.6.9 black==24.8.0 pytest==8.3.3

      # Ruff lint
      - name: Ruff (lint)
        run: ruff check .

      # Black formatting check (no writes)
      - name: Black (check)
        run: black --check .

      # Pytest (if there are tests; pass if none)
      - name: Pytest
        run: |
          if [ -d "tests" ]; then
            pytest -q
          else
            echo "No tests/ directory; skipping pytest."
          fi

  validate:
    name: validate
    runs-on: ubuntu-latest
    needs: [quality]          # only validate after quality succeeds
    permissions:
      contents: read
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run ELIS repository validator
        run: |
          python -m pip install --upgrade pip
          # validator currently has no extra deps; adjust if needed
          python scripts/validate_json.py
