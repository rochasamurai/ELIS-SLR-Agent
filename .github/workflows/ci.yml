# .github/workflows/ci.yml
# ELIS - CI
# Purpose:
#   Lightweight CI that runs on PRs (and when this workflow file changes).
#   - quality: Ruff (lint) + Black (check)
#   - tests: runs pytest ONLY if test files exist (safe skip otherwise)
#   - validate: runs validator; does NOT block on warnings
#
# Notes:
#   - We do NOT use hashFiles() at job-level (unsupported here).
#   - Instead, we check for test file presence with shell globbing.
#   - validate depends only on quality (so it still runs when tests are absent).

name: ELIS - CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    paths:
      - ".github/workflows/ci.yml"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  quality:
    name: quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tools (Ruff, Black)
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.6.9 black==24.8.0

      - name: Ruff (lint)
        run: ruff check .

      - name: Black (check)
        run: black --check .

  tests:
    name: tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install runtime + pytest
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      # Gate on the presence of *any* test file to avoid pytest exit code 5 (no tests collected).
      - name: Run pytest if tests exist
        shell: bash
        run: |
          shopt -s nullglob globstar
          files=(tests/**/*.py)
          if (( ${#files[@]} == 0 )); then
            echo "No test files under tests/**.py â€“ skipping pytest."
            exit 0
          fi
          echo "Found ${#files[@]} test file(s). Running pytest..."
          pytest -q

  validate:
    name: validate
    needs: [ quality ]   # Do not depend on tests (which may be skipped)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install runtime deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run validator (non-blocking)
        run: |
          python scripts/validate_json.py || echo "::warning ::validator returned non-zero (tolerated by CI)"
