name: ELIS - Agent Nightly
# =============================================================================
# Purpose
#   Nightly pipeline to run:
#     1) Appendix A (Search)  -> writes json_jsonl/ELIS_Appendix_A_Search_rows.json
#     2) Appendix B (Screen)  -> writes json_jsonl/ELIS_Appendix_B_Screening_rows.json
#   Then uploads both as a single artifact with the canonical name:
#     - elis-nightly-artefacts
#
# Triggers
#   - Manual (workflow_dispatch)
#   - Nightly schedule
#
# Notes
#   - No 'push' trigger: avoids unexpected executions on every commit.
#   - The search step appends a compact summary to $GITHUB_STEP_SUMMARY.
#   - Artifact name is EXACT to align with Housekeeping’s 7-day nightly retention.
# =============================================================================

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 2 * * *" # 02:30 UTC nightly

permissions:
  contents: read

concurrency:
  group: agent-nightly-${{ github.ref }}
  cancel-in-progress: false

jobs:
  nightly:
    name: A→B Nightly
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install runtime dependencies (pinned)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e . --no-deps

      # -----------------------------------------------------------------------
      # Appendix A — Harvest + Merge
      # Harvests from public adapters (no auth required), then merges.
      # Writes: json_jsonl/ELIS_Appendix_A_Search_rows.json
      # -----------------------------------------------------------------------
      - name: Run Appendix A (Harvest + Merge)
        env:
          # Optional: adds a polite contact to the User-Agent for public APIs.
          ELIS_CONTACT: ${{ secrets.ELIS_CONTACT_EMAIL || '' }}
        run: |
          set -euo pipefail
          mkdir -p json_jsonl
          elis harvest crossref \
            --search-config config/searches/electoral_integrity_search.yml \
            --tier pilot \
            --output json_jsonl/harvest_crossref.json
          elis harvest openalex \
            --search-config config/searches/electoral_integrity_search.yml \
            --tier pilot \
            --output json_jsonl/harvest_openalex.json
          elis merge \
            --inputs json_jsonl/harvest_crossref.json json_jsonl/harvest_openalex.json \
            --output json_jsonl/ELIS_Appendix_A_Search_rows.json \
            --report json_jsonl/merge_report.json

      # -----------------------------------------------------------------------
      # Appendix B — Screen
      # Reads A's JSON, normalises and emits a screening rows file.
      # Writes: json_jsonl/ELIS_Appendix_B_Screening_rows.json
      # -----------------------------------------------------------------------
      - name: Run Appendix B (Screen)
        run: |
          set -euo pipefail
          elis screen \
            --input  json_jsonl/ELIS_Appendix_A_Search_rows.json \
            --output json_jsonl/ELIS_Appendix_B_Screening_rows.json

      # -----------------------------------------------------------------------
      # Upload nightly bundle (EXACT NAME) — required by Housekeeping policy
      # Nightly retention is 7 days; Housekeeping will also enforce this.
      # -----------------------------------------------------------------------
      - name: Upload nightly bundle (canonical name)
        uses: actions/upload-artifact@v4
        with:
          name: elis-nightly-artefacts
          if-no-files-found: error
          retention-days: 7
          path: |
            json_jsonl/ELIS_Appendix_A_Search_rows.json
            json_jsonl/ELIS_Appendix_B_Screening_rows.json
